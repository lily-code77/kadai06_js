<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Lab | 食べたい料理に出会える場所</title>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/style.css">
    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- tesseract.js v5 -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
</head>

<body>
    <section>
        <button id="out">ログアウト</button>
        <h1 id="status">Login...</h1>
    </section>
    
    <!-- コンテンツ表示画面 -->
    <section>
        名前：<span id="uname"></span><br>
        <img src="" id="prof">
    </section>

    <section>
        <h1>マイレシピ　ラボ</h1>
        
        <!-- imgを選択し、画面に表示させる -->
        <div>
            <!-- multipleを入れることによって複数のファイル選択ができる -->
            <h3>画像は1つずつ選択してください（.jpegか.png）</h3>
            <input id="input" type="file" />
            <div class="preview"></div>
        </div>
        
        <!-- PDFに変換 -->
        <div>
            <button id="convert">convert</button><br>
            <!-- PDF変換後の結果を表示 -->
            <div class="inputRecipeName">料理名: <input type="text" id="recipeName"></div>
            <textarea class="textedImg" cols="30" rows="10"></textarea>
        </div>
        
        <!-- Firebaseに保存し、保存されたレシピをどんどんマイレシピ集の一レシピとして画面に表示させていく -->
        <div>
            <button id="save">save</button>
            <h2>マイレシピ集</h2>
            <div class="myRecipe">
                <ul class="item"></ul>
            </div>
        </div>
    </section>

    <!-- firebase -->
    <script type="module">
        // 必要なFirebaseライブラリを読み込み
        import { initializeApp }
            from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, onChildAdded, remove, onChildRemoved }
            from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js"
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged }
            from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        // firebaseApikey.jsからexportされているオブジェクトを
        // main.jsでfirebaseConfigという変数名で取り扱うよ、という記述。
        import firebaseConfig from "./js/firebaseApikey.js";

        const app = initializeApp(firebaseConfig);

        // Firebase-RealtimeDatabase接続
        const db = getDatabase(app); //RealtimeDBに接続

        // Google Auth(認証用)
        const provider = new GoogleAuthProvider();
        provider.addScope('https://www.googleapis.com/auth/contacts.readonly');
        const auth = getAuth();

        // loginしていれば処理します
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in, see docs for a list of available properties
                // https://firebase.google.com/docs/reference/js/firebase.User
                const uid = user.uid;
                // ユーザー情報取得できます
                if (user !== null) {
                    user.providerData.forEach((profile) => {
                        // login情報取得
                        $("#uname").text(profile.displayName);
                        $("#prof").attr("src", profile.photoURL);
                        console.log("Sign-in provider: " + profile.providerId);
                        console.log("Provider-specific UID: " + profile.uid);
                        console.log("Email: " + profile.email);
                        console.log("Photo URL: " + profile.photoURL);
                    });
                    $("#status").fadeOut(500);
                }
            else {
                _redirect(); // User is signed out
            }
        }
        });

        // logout処理
        $("#out").on("click", function () {
            // signInWithRedirect(auth, provider);
            signOut(auth).then(() => {
                //  Sign out successful.
                _redirect();
            }).catch((error) => {
                // An error happened.
                console.error(error);
            });
        })

        // login画面へのリダイレクト
        function _redirect() {
            location.href = "index.html";
        }

    </script>

    <script src="./js/script.js"></script>
    <script src="./js/file.js"></script>
    <script src="./js/pdf.js"></script>
    <script type="module" src="./js/save.js"></script>
</body>

</html>