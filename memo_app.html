<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <button id="out">ログアウト</button>
    <h1 id="status">Login...</h1>

    <!-- コンテンツ表示画面 -->
    <div>
        <div>
            名前：<span id="uname"></span><br>
            <img src="" id="prof">
        </div>
        <div>
            <select id="title">
                <option value="memo1">memo1</option>
                <option value="memo2">memo2</option>
                <option value="memo3">memo3</option>
            </select>
        </div>
        <div>
            <textarea id="text" cols="30" rows="10"></textarea>
            <button id="send">送信</button>
        </div>
    </div>

    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- firebase -->
    <script type="module">
        // 必要なFirebaseライブラリを読み込み
        import { initializeApp }
            from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, onChildAdded, remove, onChildRemoved }
            from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js"
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged }
            from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        // firebaseApikey.jsからexportされているオブジェクトを
        // main.jsでfirebaseConfigという変数名で取り扱うよ、という記述。
        import firebaseConfig from "./js/firebaseApikey.js";

        const app = initializeApp(firebaseConfig);

        // Firebase-RealtimeDatabase接続
        const db = getDatabase(app); //RealtimeDBに接続

        // Google Auth(認証用)
        const provider = new GoogleAuthProvider();
        provider.addScope('https://www.googleapis.com/auth/contacts.readonly');
        const auth = getAuth();

        // loginしていれば処理します
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in, see docs for a list of available properties
                // https://firebase.google.com/docs/reference/js/firebase.User
                const uid = user.uid;
                // ユーザー情報取得できます
                if (user !== null) {
                    user.providerData.forEach((profile) => {
                        // login情報取得
                        $("#uname").text(profile.displayName);
                        $("#prof").attr("src", profile.photoURL);
                        console.log("Sign-in provider: " + profile.providerId);
                        console.log("Provider-specific UID: " + profile.uid);
                        console.log("Email: " + profile.email);
                        console.log("Photo URL: " + profile.photoURL);
                    });
                    $("#status").fadeOut(500);
                }

                // データ登録（Click)
                $("#send").on("click", function () {
                    const msg = {
                        title: $("#title").val(),
                        text: $("#text").val()
                    }
                    const dbRef = ref(db, "users/" + uid + "/memo/" + $("#title").val()); //RealtimeDB内の"chat"を使う
                    set(dbRef, msg); //DBに値をセットする
                });

                //最初にデータ取得&onSnapshotでリアルタイムにデータを取得
                $("#title").on("change", function () {
                    const dbRef = ref(db, "users/" + uid + "/memo" + $(this).val()); //RealtimeDB内の"chat"を使う
                    onValue(dbRef, function (data) {
                        console.log(data);
                        const msg = data.val(); //オブジェクトデータを取得し、変数msgに代入
                        // const key = data.key; //データのユニークキー（削除や更新に使用可能）
                        $("#text").val(msg.text);
                    });
                });
            }
            else {
                _redirect(); // User is signed out
            }
        });

        // logout処理
        $("#out").on("click", function () {
            // signInWithRedirect(auth, provider);
            signOut(auth).then(() => {
                //  Sign out successful.
                _redirect();
            }).catch((error) => {
                // An error happened.
                console.error(error);
            });
        })

        // login画面へのリダイレクト
        function _redirect() {
            location.href = "index.html";
        }

    </script>


</body>

</html>